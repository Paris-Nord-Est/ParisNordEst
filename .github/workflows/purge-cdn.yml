name: Purge jsDelivr CDN Cache

on:
  push:
    tags:
      - 'v*' # Triggers on any tag starting with 'v' (e.g., v3.0.1, v3.1.0)

jobs:
  purge-cache:
    runs-on: ubuntu-latest
    name: Purge jsDelivr Cache for @latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for jsDelivr to index new tag
        run: |
          echo "Waiting 30 seconds for jsDelivr to index the new tag..."
          sleep 30

      - name: Purge JavaScript bundle
        run: |
          echo "Purging app.js from jsDelivr cache..."
          curl -X POST "https://purge.jsdelivr.net/gh/Baldrani/ParisNordEst@latest/source/dist/app.js"

      - name: Purge CSS bundle
        run: |
          echo "Purging main.css from jsDelivr cache..."
          curl -X POST "https://purge.jsdelivr.net/gh/Baldrani/ParisNordEst@latest/source/dist/main.css"

      - name: Purge image assets
        run: |
          echo "Purging image assets from jsDelivr cache..."
          # Purge hero slider images
          curl -X POST "https://purge.jsdelivr.net/gh/Baldrani/ParisNordEst@latest/source/images/home/slider/542599450_17854130469531086_412195545774409256_n.webp"
          curl -X POST "https://purge.jsdelivr.net/gh/Baldrani/ParisNordEst@latest/source/images/home/slider/le-bar.jpg"
          # Purge banner image
          curl -X POST "https://purge.jsdelivr.net/gh/Baldrani/ParisNordEst@latest/source/images/home/banner/paris-nord-est-banner.jpg"
          # Purge logos
          curl -X POST "https://purge.jsdelivr.net/gh/Baldrani/ParisNordEst@latest/source/images/casquette/vectoriel/logo-horizontal-white.svg"
          curl -X POST "https://purge.jsdelivr.net/gh/Baldrani/ParisNordEst@latest/source/images/casquette/vectoriel/logo-round-white.svg"

      - name: Verify purge
        run: |
          echo "âœ… Cache purge completed!"
          echo "New tag: ${{ github.ref_name }}"
          echo "All @latest URLs have been purged and will serve from this tag immediately."

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**New version:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Purged URLs:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… JavaScript: \`app.js\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CSS: \`main.css\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Images: Hero slider, banner, and logos" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify changes at your BigCartel store" >> $GITHUB_STEP_SUMMARY
          echo "2. If needed, update BigCartel CSS by running \`dugway build\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Changes should be live immediately on your store!" >> $GITHUB_STEP_SUMMARY
